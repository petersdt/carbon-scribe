name: Deploy to Staging Environment

on:
  push:
    branches: [ develop, staging ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - uat

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}

jobs:
  deploy:
    name: ðŸš€ Deploy CarbonScribe
    runs-on: ubuntu-latest
    environment: ${{ env.ENVIRONMENT }}
    
    strategy:
      matrix:
        layer:
          - name: stellar-core
            path: stellar-core
            dockerfile: Dockerfile.stellar
          - name: project-portal
            path: project-portal/project-portal-backend
            dockerfile: Dockerfile
          - name: corporate-backend
            path: corporate-platform/corporate-platform-backend
            dockerfile: Dockerfile
          - name: verification-layer
            path: verification-layer/satellite-oracle-network
            dockerfile: Dockerfile
          - name: financialization
            path: financialization/project-financing
            dockerfile: Dockerfile
          - name: global-registry
            path: global-registry/api-gateway
            dockerfile: Dockerfile
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log into Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.layer.name }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=${{ env.ENVIRONMENT }},enable=${{ github.event_name == 'workflow_dispatch' }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.layer.path }}
          file: ${{ matrix.layer.path }}/${{ matrix.layer.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ENVIRONMENT=${{ env.ENVIRONMENT }}
      
      - name: Deploy to Kubernetes
        uses: steebchen/kubectl@v2
        with:
          config: ${{ secrets.KUBECONFIG_STAGING }}
          command: |
            set -x
            kubectl set image deployment/${{ matrix.layer.name }} \
              ${{ matrix.layer.name }}=${{ steps.meta.outputs.tags }} \
              --namespace=carbon-scribe-${{ env.ENVIRONMENT }}
            kubectl rollout status deployment/${{ matrix.layer.name }} \
              --namespace=carbon-scribe-${{ env.ENVIRONMENT }} \
              --timeout=300s
      
      - name: Run Health Checks
        run: |
          # Add health check endpoints for each service
          services=(
            "project-portal-backend:3000"
            "corporate-backend:3001"
            "api-gateway:8080"
          )
          
          for service in "${services[@]}"; do
            name=$(echo $service | cut -d: -f1)
            port=$(echo $service | cut -d: -f2)
            echo "Checking health of $name..."
            curl -f http://$name:$port/health || exit 1
          done
      
      - name: Notify Deployment
        uses: 8398a7/action-slack@v3
        with:
          channel: '#deployments'
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()