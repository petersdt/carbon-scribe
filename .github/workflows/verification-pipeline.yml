name: Earth Data Verification Pipeline

on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  workflow_dispatch:

jobs:
  satellite-data:
    name: üõ∞Ô∏è Satellite Data Processing
    runs-on: ubuntu-latest
    environment: verification
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Geospatial Libraries
        run: |
          sudo apt-get update
          sudo apt-get install -y gdal-bin libgdal-dev
          pip install rasterio geopandas sentinelhub scikit-learn
      
      - name: Download Sentinel-2 Data
        env:
          SENTINELHUB_CLIENT_ID: ${{ secrets.SENTINELHUB_CLIENT_ID }}
          SENTINELHUB_CLIENT_SECRET: ${{ secrets.SENTINELHUB_CLIENT_SECRET }}
        run: |
          cd verification-layer/satellite-oracle-network
          python scripts/download_sentinel_data.py \
            --projects active_projects.json \
            --output data/satellite/
      
      - name: Calculate NDVI
        run: |
          cd verification-layer/satellite-oracle-network
          python src/ndvi_calculator.py \
            --input data/satellite/ \
            --output data/ndvi/
      
      - name: Detect Changes
        run: |
          cd verification-layer/satellite-oracle-network
          python src/change_detection.py \
            --current data/ndvi/latest/ \
            --previous data/ndvi/previous/ \
            --output data/alerts/
      
      - name: Upload to IPFS
        run: |
          cd verification-layer/satellite-oracle-network
          python scripts/upload_to_ipfs.py \
            --data data/alerts/ \
            --metadata data/metadata.json
      
      - name: Submit to Blockchain
        env:
          STELLAR_SECRET_KEY: ${{ secrets.STELLAR_VERIFICATION_KEY }}
        run: |
          cd verification-layer/satellite-oracle-network
          python scripts/submit_to_blockchain.py \
            --alerts data/alerts/verified_alerts.json \
            --network testnet

  iot-data:
    name: üì° IoT Data Aggregation
    runs-on: ubuntu-latest
    environment: verification
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Run IoT Gateway
        run: |
          cd verification-layer/iot-device-network
          go run cmd/iot-gateway/main.go \
            --config config/production.yaml \
            --output data/iot/
      
      - name: Validate Sensor Data
        run: |
          cd verification-layer/iot-device-network
          python scripts/validate_sensor_data.py \
            --input data/iot/ \
            --output data/validated/

  ground-truth:
    name: üë£ Ground Truth Validation
    runs-on: ubuntu-latest
    environment: verification
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Process Field Data
        run: |
          cd verification-layer/ground-truth-validation
          node scripts/process_field_data.js \
            --photos data/photos/ \
            --gps data/gps/ \
            --output data/ground_truth/

  verification-consensus:
    name: ‚úÖ Verification Consensus
    runs-on: ubuntu-latest
    needs: [satellite-data, iot-data, ground-truth]
    environment: verification
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Data Fusion
        run: |
          cd verification-layer/satellite-oracle-network
          python src/oracle_consensus/data_fusion.py \
            --satellite data/ndvi/ \
            --iot data/validated/ \
            --ground data/ground_truth/ \
            --output data/consensus/
      
      - name: Generate Verification Report
        run: |
          cd verification-layer/satellite-oracle-network
          python scripts/generate_verification_report.py \
            --consensus data/consensus/ \
            --output reports/verification_report_$(date +%Y%m%d).pdf
      
      - name: Mint Verified Credits
        env:
          STELLAR_ISSUER_KEY: ${{ secrets.STELLAR_ISSUER_KEY }}
        run: |
          cd stellar-core
          cargo run --bin mint-credits \
            --report ../verification-layer/reports/verification_report_$(date +%Y%m%d).pdf \
            --network mainnet