name: Project Portal Backend CI
on:
  push:
    paths:
      - 'project-portal/project-portal-backend/**'
  pull_request:
    paths:
      - 'project-portal/project-portal-backend/**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: project-portal/project-portal-backend
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: go.sum
      
      - name: Check Go module
        run: |
          if [ ! -f "go.mod" ]; then
            echo "‚ùå ERROR: go.mod file not found"
            exit 1
          fi
          echo "‚úÖ Go module found: $(cat go.mod | head -1)"
      
      - name: Download dependencies
        run: go mod download
      
      - name: Build (exclude future-tagged files)
        id: build
        run: |
          echo "üî® Building current implementation (excluding 'future' tagged files)..."
          
          # Count packages to build
          PACKAGES=$(go list ./...)
          echo "Total packages found: $(echo "$PACKAGES" | wc -l)"
          
          # Build excluding future-tagged files
          if go build -tags "!future" ./...; then
            echo "‚úÖ Build successful"
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Build failed"
            echo "build_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Test (exclude future-tagged files)
        if: steps.build.outputs.build_success == 'true'
        run: |
          echo "üß™ Testing current implementation (excluding 'future' tagged files)..."
          
          # Count test files
          TEST_FILES=$(find . -name "*_test.go" -type f | wc -l)
          echo "Test files found: $TEST_FILES"
          
          if [ "$TEST_FILES" -gt 0 ]; then
            go test -tags "!future" ./...
          else
            echo "üìù No test files found (excluding future-tagged files)"
          fi
      
      - name: List future-tagged files (for debugging)
        if: always()
        run: |
          echo "üîÆ Future-tagged files (not included in build):"
          find . -name "*.go" -type f -exec grep -l "//go:build future" {} \; 2>/dev/null || echo "None found"
      
      - name: Verify can build with future tags
        if: always()
        run: |
          echo "üîÑ Checking if project can build WITH future tags..."
          if go build -tags "future" ./... 2>&1 | grep -i "error:"; then
            echo "‚ö†Ô∏è WARNING: Future-tagged files have compilation errors"
            echo "This is OK for now, but fix before removing the future tag"
          else
            echo "‚úÖ Future-tagged files compile successfully"
          fi