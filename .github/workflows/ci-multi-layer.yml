name: CarbonScribe Multi-Layer CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 0' # Weekly on Sundays at 2 AM

env:
  CARGO_TERM_COLOR: always
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  GO_VERSION: '1.21'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Layer 1: Stellar Blockchain Core (Soroban Rust Contracts)
  layer1-stellar:
    name: üü¶ Layer 1 - Stellar Core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      
      - name: Setup Rust Toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
          profile: minimal
          override: true
      
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: 'stellar-core'
      
      - name: Install Soroban CLI
        run: |
          curl -sSfL https://raw.githubusercontent.com/stellar/soroban-cli/main/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Build Stellar Core Contracts
        run: |
          cd stellar-core
          find . -name "Cargo.toml" -exec dirname {} \; | while read dir; do
            echo "Building contract in $dir"
            cd "$dir"
            cargo build --target wasm32-unknown-unknown --release
            soroban contract optimize --wasm target/wasm32-unknown-unknown/release/*.wasm
            cd -
          done
      
      - name: Run Rust Tests
        run: |
          cd stellar-core
          cargo test --locked --verbose
          cargo clippy -- -D warnings
          cargo fmt -- --check
      
      - name: Security Audit
        uses: actions-rs/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # Layer 2: Verification Layer (Python + Go)
  layer2-verification:
    name: üõ∞Ô∏è Layer 2 - Verification
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ['satellite-oracle-network', 'iot-device-network', 'ground-truth-validation']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python (for satellite-oracle)
        if: matrix.service == 'satellite-oracle-network'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: verification-layer/${{ matrix.service }}/requirements.txt
      
      - name: Setup Go (for iot-device-network)
        if: matrix.service == 'iot-device-network'
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: verification-layer/${{ matrix.service }}/go.sum
      
      - name: Setup Node.js (for ground-truth-validation)
        if: matrix.service == 'ground-truth-validation'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: verification-layer/${{ matrix.service }}/package-lock.json
      
      - name: Install Python Dependencies
        if: matrix.service == 'satellite-oracle-network'
        run: |
          cd verification-layer/${{ matrix.service }}
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov black flake8 mypy
      
      - name: Install Go Dependencies
        if: matrix.service == 'iot-device-network'
        run: |
          cd verification-layer/${{ matrix.service }}
          go mod download
      
      - name: Install Node.js Dependencies
        if: matrix.service == 'ground-truth-validation'
        run: |
          cd verification-layer/${{ matrix.service }}
          npm ci
      
      - name: Run Tests
        run: |
          cd verification-layer/${{ matrix.service }}
          if [ -f "pytest.ini" ]; then
            python -m pytest --cov=. --cov-report=xml
            black --check .
            flake8 .
            mypy .
          elif [ -f "go.mod" ]; then
            go test ./... -v -coverprofile=coverage.out
            go vet ./...
            gofmt -d .
          elif [ -f "package.json" ]; then
            npm test
            npx tsc --noEmit
          fi
      
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        if: success()
        with:
          file: verification-layer/${{ matrix.service }}/coverage.xml
          flags: verification_${{ matrix.service }}

  # Layer 3: Project Portal (Next.js + Go)
  layer3-project-portal:
    name: üå± Layer 3 - Project Portal
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js (Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: project-portal/project-portal-web/package-lock.json
      
      - name: Setup Go (Backend)
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: project-portal/project-portal-backend/go.sum
      
      - name: Install Frontend Dependencies
        run: |
          cd project-portal/project-portal-web
          npm ci
      
      - name: Install Backend Dependencies
        run: |
          cd project-portal/project-portal-backend
          go mod download
      
      - name: TypeScript Check
        run: |
          cd project-portal/project-portal-web
          npx tsc --noEmit
      
      - name: Lint Frontend
        run: |
          cd project-portal/project-portal-web
          npm run lint || echo "No lint script, skipping"
          npx prettier --check .
      
      - name: Test Frontend
        run: |
          cd project-portal/project-portal-web
          npm run test -- --passWithNoTests || echo "No tests configured"
      
      - name: Build Frontend
        run: |
          cd project-portal/project-portal-web
          npm run build
      
      - name: Test Backend
        run: |
          cd project-portal/project-portal-backend
          go test ./... -v
          go vet ./...
          gofmt -d .
      
      - name: Build Backend
        run: |
          cd project-portal/project-portal-backend
          go build -o portal-api ./cmd/portal-api

  # Layer 4: Corporate Platform (Nest.js + Next.js)
  layer4-corporate-platform:
    name: üè¢ Layer 4 - Corporate Platform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            corporate-platform/corporate-platform-backend/package-lock.json
            corporate-platform/corporate-platform-web/package-lock.json
      
      - name: Install Backend Dependencies
        run: |
          cd corporate-platform/corporate-platform-backend
          npm ci
      
      - name: Install Frontend Dependencies
        run: |
          cd corporate-platform/corporate-platform-web
          npm ci
      
      - name: Generate Prisma Client
        run: |
          cd corporate-platform/corporate-platform-backend
          npx prisma generate
      
      - name: TypeScript Check
        run: |
          cd corporate-platform/corporate-platform-backend
          npx tsc --noEmit
          cd ../frontend
          npx tsc --noEmit
      
      - name: Lint Codebase
        run: |
          cd corporate-platform/corporate-platform-backend
          npm run lint || echo "No lint script"
          cd ../frontend
          npm run lint || echo "No lint script"
      
      - name: Run Backend Tests
        run: |
          cd corporate-platform/corporate-platform-backend
          npm test -- --passWithNoTests || echo "No tests configured"
      
      - name: Run Frontend Tests
        run: |
          cd corporate-platform/corporate-platform-web
          npm run test -- --passWithNoTests || echo "No tests configured"
      
      - name: Build Backend
        run: |
          cd corporate-platform/corporate-platform-backend
          npm run build
      
      - name: Build Frontend
        run: |
          cd corporate-platform/corporate-platform-web
          npm run build

  # Layer 5: Financialization Engine
  layer5-financialization:
    name: üí∞ Layer 5 - Financialization
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: ['carbon-derivatives', 'project-financing', 'cross-chain-bridge']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust (for Rust components)
        if: matrix.component == 'carbon-derivatives' || matrix.component == 'cross-chain-bridge'
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
      
      - name: Setup Go (for project-financing)
        if: matrix.component == 'project-financing'
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Build & Test Component
        run: |
          cd financialization/${{ matrix.component }}
          if [ -f "Cargo.toml" ]; then
            cargo build --release
            cargo test
            cargo clippy -- -D warnings
          elif [ -f "go.mod" ]; then
            go mod download
            go test ./... -v
            go build ./cmd/financing-api
          fi

  # Layer 6: Global Registry
  layer6-global-registry:
    name: üåç Layer 6 - Global Registry
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: ['registry-of-registries', 'api-gateway', 'compliance-adapter']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        if: matrix.component == 'registry-of-registries'
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
      
      - name: Setup Go
        if: matrix.component == 'api-gateway'
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Setup Python
        if: matrix.component == 'compliance-adapter'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Build & Test Component
        run: |
          cd global-registry/${{ matrix.component }}
          if [ -f "Cargo.toml" ]; then
            cargo build --release
            cargo test
          elif [ -f "go.mod" ]; then
            go mod download
            go test ./... -v
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
            pip install pytest black flake8
            python -m pytest
            black --check .
            flake8 .
          fi

  # Layer 7: Transparency Layer
  layer7-transparency:
    name: üîç Layer 7 - Transparency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js (Dashboard)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: transparency-layer/public-dashboard/package-lock.json
      
      - name: Setup Go (Archiver)
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: transparency-layer/data-availability/archiver-node/go.sum
      
      - name: Install Dashboard Dependencies
        run: |
          cd transparency-layer/public-dashboard
          npm ci
      
      - name: Install Archiver Dependencies
        run: |
          cd transparency-layer/data-availability/archiver-node
          go mod download
      
      - name: Build Dashboard
        run: |
          cd transparency-layer/public-dashboard
          npm run build
      
      - name: Test Archiver
        run: |
          cd transparency-layer/data-availability/archiver-node
          go test ./... -v

  # Integration & E2E Tests
  integration-tests:
    name: üß™ Integration Tests
    runs-on: ubuntu-latest
    needs: [layer1-stellar, layer2-verification, layer3-project-portal, layer4-corporate-platform]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Start Test Environment
        run: |
          docker-compose -f docker-compose.test.yml up -d
          sleep 30 # Wait for services to start
      
      - name: Run Integration Tests
        run: |
          cd corporate-platform/corporate-platform-backend
          npm run test:e2e || echo "No E2E tests configured"
      
      - name: Tear down Test Environment
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml down

  # Security Scanning
  security:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --all-projects --severity-threshold=high
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        if: success()
        with:
          sarif_file: 'trivy-results.sarif'

  # Code Quality
  code-quality:
    name: üìê Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Prettier Check
        uses: actionsx/prettier@v3
        with:
          args: --check "**/*.{js,jsx,ts,tsx,json,md,yml,yaml}"
          prettier_version: latest
      
      - name: Check Commit Messages
        uses: wagoid/commitlint-github-action@v5
      
      - name: Analyze with SonarCloud
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Generate Documentation
  docs:
    name: üìö Generate Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install TypeDoc
        run: npm install -g typedoc
      
      - name: Generate API Documentation
        run: |
          for dir in */; do
            if [ -f "$dir/package.json" ] && grep -q "@nestjs" "$dir/package.json"; then
              cd "$dir"
              npx typedoc --out ../../docs/api/$dir src
              cd -
            fi
          done
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs