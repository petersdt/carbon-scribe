name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to rollback to'
        required: true
      reason:
        description: 'Reason for rollback'
        required: true

jobs:
  rollback:
    name: ðŸš¨ Emergency Rollback
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Validate Rollback Version
        run: |
          echo "Rolling back to version ${{ github.event.inputs.version }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
      
      - name: Rollback Kubernetes Deployments
        uses: steebchen/kubectl@v2
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG_PRODUCTION }}
        with:
          command: |
            for deployment in $(kubectl get deployments -n carbon-scribe --no-headers | awk '{print $1}'); do
              echo "Rolling back $deployment..."
              kubectl rollout undo deployment/$deployment -n carbon-scribe
            done
      
      - name: Verify Rollback
        run: |
          echo "Verifying rollback completion..."
          sleep 30
          curl -f https://api.carbonscribe.com/health || echo "Health check may be failing during rollback"
      
      - name: Notify Emergency Channel
        uses: 8398a7/action-slack@v3
        with:
          channel: '#emergency'
          status: ${{ job.status }}
          text: |
            ðŸš¨ EMERGENCY ROLLBACK
            Version: ${{ github.event.inputs.version }}
            Reason: ${{ github.event.inputs.reason }}
            By: @${{ github.actor }}
          fields: repo,commit,author
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_EMERGENCY_WEBHOOK }}