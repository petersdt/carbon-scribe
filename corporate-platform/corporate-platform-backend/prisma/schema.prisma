datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model Company {
  id                   String            @id @default(cuid())
  name                 String
  retirements          Retirement[]
  users                User[]
  ipWhitelists         IpWhitelist[]
  bids                 Bid[]
  retirementTargets    RetirementTarget[]
  annualRetirementTarget Int?
  netZeroTarget          Int?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
}

model Credit {
  id          String       @id @default(cuid())
  projectName String
  country     String?
  methodology String?
  standard    String?
  sdgs        String?
  vintageYear Int?
  price       Float?
  totalAmount Int
  available   Int
  retirements Retirement[]
  auctions    Auction[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Search optimization
  searchVector    String?
  featured        Boolean   @default(false)
  featuredUntil   DateTime?
  viewCount       Int       @default(0)
  purchaseCount   Int       @default(0)
  lastPurchasedAt DateTime?

  @@index([searchVector])
  @@index([featured])
  @@index([viewCount])
  @@index([purchaseCount])
}

model Retirement {
  id                String    @id @default(cuid())
  companyId         String
  company           Company   @relation(fields: [companyId], references: [id])
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  
  creditId          String
  credit            Credit    @relation(fields: [creditId], references: [id])
  
  // Retirement details
  amount            Int
  purpose           String    // scope1, scope2, scope3, corporate, events, product
  purposeDetails    String?   // Additional context
  
  // Pricing
  priceAtRetirement Float
  
  // Certificate details
  certificateId     String?    @unique
  certificateUrl    String?
  
  // Blockchain
  transactionHash   String?
  transactionUrl    String?
  verifiedAt        DateTime?
  
  // Metadata
  retiredAt         DateTime  @default(now())
  
  // Relations
  certificate       RetirementCertificate?

  @@index([companyId])
  @@index([userId])
  @@index([creditId])
  @@index([purpose])
  @@index([retiredAt])
}

model RetirementCertificate {
  id                String    @id @default(cuid())
  retirementId      String    @unique
  retirement        Retirement @relation(fields: [retirementId], references: [id])
  
  certificateNumber String    @unique // e.g., "RET-2024-001234"
  pdfUrl            String
  ipfsHash          String?   // IPFS storage for permanence
  
  // Certificate data (snapshot)
  companyName       String
  retirementDate    DateTime
  creditProject     String
  creditAmount      Int
  creditPurpose     String
  transactionHash   String?
  
  createdAt         DateTime  @default(now())
}

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  password             String
  firstName            String
  lastName             String
  role                 String    @default("viewer")
  companyId            String
  company              Company   @relation(fields: [companyId], references: [id])
  refreshToken         String?
  lastLoginAt          DateTime?
  lastLoginIp          String?
  isActive             Boolean   @default(true)
  emailVerified        Boolean   @default(false)
  passwordResetToken   String?
  passwordResetExpires DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  sessions             Session[]
  retirements          Retirement[]
  bids                 Bid[]
  wonAuctions          Auction[]

  @@unique([companyId, email])
  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  isValid      Boolean  @default(true)
  createdAt    DateTime @default(now())
  lastUsedAt   DateTime?

  @@index([refreshToken])
  @@index([expiresAt])
}

model IpWhitelist {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])

  cidr        String
  description String?
  createdBy   String

  isActive Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, cidr])
  @@index([companyId])
}

model AuditLog {
  id        String   @id @default(cuid())
  companyId String?
  userId    String?

  eventType String
  severity  String

  ipAddress  String?
  userAgent  String?
  resource   String?
  method     String?
  details    Json?
  oldValue   Json?
  newValue   Json?
  status     String
  statusCode Int?
  timestamp  DateTime @default(now())

  @@index([companyId])
  @@index([userId])
  @@index([eventType])
  @@index([timestamp])
  @@index([severity])
}

model Auction {
  id                String   @id @default(cuid())
  creditId          String
  credit            Credit   @relation(fields: [creditId], references: [id])
  quantity          Int
  remaining         Int
  startPrice        Float
  currentPrice      Float
  floorPrice        Float
  priceDecrement    Float
  decrementInterval Int
  startTime         DateTime
  endTime           DateTime
  lastPriceUpdate   DateTime
  status            String
  winnerId          String?
  winner            User?    @relation(fields: [winnerId], references: [id])
  finalPrice        Float?
  bids              Bid[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([creditId])
  @@index([status])
}

model Bid {
  id        String   @id @default(cuid())
  auctionId String
  auction   Auction  @relation(fields: [auctionId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  bidPrice  Float
  quantity  Int
  status    String
  createdAt DateTime @default(now())

  @@index([auctionId])
  @@index([companyId])
  @@index([userId])
}

model RetirementTarget {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  year      Int
  month     Int
  target    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, year, month])
}
